services:
  www:
    build: 
      context: ./web/
      dockerfile: www.Dockerfile
    image: php:apache
    volumes:
      - "./:/var/www/html"
    environment:
      - TZ=${TIMEZONE}
      - APIKEY=${KEY}
      - MYSQL_SERVER=${SERVERNAME}
      - MYSQL_DATABASE=${DATABASE}
      - MYSQL_USER=${USER}
      - MYSQL_PASSWORD=${PASSWORD}
      - MYSQL_TABLE=${TABLE}
    ports:
      - 80:80
  db:
    image: mysql:latest
    environment:
      - TZ=${TIMEZONE}
      - MYSQL_DATABASE=${DATABASE}
      - MYSQL_USER=${USER}
      - MYSQL_PASSWORD=${PASSWORD}
      - MYSQL_ALLOW_EMPTY_PASSWORD=${ALLOWEMPTYPASSWORD}
      - MYSQL_TABLE=${TABLE}
    volumes:
      - "./db/init.sql:/docker-entrypoint-initdb.d/init.sql"
      - "/opt/mysql_data:/var/lib/mysql"
  phpmyadmin:
    build:
      context: ./db/
      dockerfile: phpmyadmin.Dockerfile
    image: phpmyadmin/phpmyadmin
    volumes:
    - "./db/phpmyadmin-servername.conf:/etc/apache2/conf-available/phpmyadmin-servername.conf"
    ports:
      - 8080:80
    environment:
      - TZ=${TIMEZONE}
      - PMA_HOST=${SERVERNAME}
      - PMA_PORT=3306
  manage_db:
    image: mysql:latest
    volumes:
      - "./db/manage_db.sh:/manage_db.sh"
      - "./db/init.sql:/docker-entrypoint-initdb.d/init.sql"
    environment:
      - TZ=${TIMEZONE}
      - CLEAR_DB=${CLEAR_DB}
      - MOVE_DB=${MOVE_DB}
      - MYSQL_DATABASE=${DATABASE}
      - MYSQL_USER=${USER}
      - MYSQL_PASSWORD=${PASSWORD}
      - MYSQL_TABLE=${TABLE}
    command: ["sh", "-c", "while ! mysqladmin ping -h db --silent; do sleep 1; done; bash /manage_db.sh"]
    depends_on:
      - db
volumes:
  mysql_data:
    driver: local 